# Date    : 2024/6/28 15:51
# File    : test_ernie_turbo.py
# Desc    : 
# Author  : Damon
# E-mail  : bingzhenli@hotmail.com


import requests
import json


def get_access_token():
    """
    使用 API Key，Secret Key 获取access_token，替换下列示例中的应用API Key、应用Secret Key
    """
    API_Key = "SQmGAVlf9p2nFNLQfZgN6sHG"
    Secret_Key = "CwnJ7e7ssw92COraHBeXqAJKOWeGs1Cs"
    url = f"https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id={API_Key}&client_secret={Secret_Key}"

    payload = json.dumps("")
    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    }

    response = requests.request("POST", url, headers=headers, data=payload)
    return response.json().get("access_token")


def main():
    url = "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/ernie-4.0-turbo-8k?access_token=" + get_access_token()

    payload = json.dumps({
        "messages": [
            {
                "role": "user",
                "content": """
你现在是一位pandas专家，精通数据分析和处理。你面对的是一个包含以下schema的数据表:

【id, 地区名称, 年份, 季度, 月份, 经济指标名称, 指标值, 指标单位, 数据来源】

其中df.head(4)为
id 地区名称    年份     季度      月份    经济指标名称     指标值 指标单位  数据来源
1  哈尔滨  2023  Q1  03  地区生产总值增速     5.4    %  省统计局
2  哈尔滨  2023  Q1  03    地区生产总值  1131.2   亿元  省统计局
27  哈尔滨  2023  Q2  06  地区生产总值增速     5.4    %  省统计局
28  哈尔滨  2023  Q2  06    地区生产总值  2451.6   亿元  省统计局

无论用户提出何种类型的数据分析需求，你都能提供准确、高效的pandas代码解决方案。你的专业领域包括但不限于:

1. 基本查询:
   - 筛选特定条件的数据
   - 排序和显示数据
   - 处理缺失值

2. 聚合分析:
   - 使用groupby进行分组统计
   - 计算各种聚合指标(如均值、总和、最大值、最小值等)
   - 透视表操作

3. 指标比较:
   - 计算同比、环比增长率
   - 进行多指标对比分析
   - 绘制对比图表的数据准备

4. 时间序列分析:
   - 重采样和频率转换
   - 移动平均线计算
   - 季节性分解

5. 高级操作:
   - 多表连接和合并
   - 数据重塑(melt, pivot等)
   - 自定义函数应用

对于每个查询，你将:
1. 理解用户的需求
2. 只需要提供清晰、简洁且高效的pandas代码
3. 注意：不需要解对结果进行解释
4. 你的回答应当准确、专业，并且易于理解和实施。
5. 如果用户的问题不明确，你会主动询问以澄清需求。

我现在提供一下样例数据：
# 2023年第二季度哈尔滨的经济数据是什么？
df[(df['地区名称'] == '哈尔滨') & (df['年季度'] == 'Q2')]

# 2023年第二季度哈尔滨的地区生产总值增速是多少
df[(df['年份'] == 2023) & (df['年季度'] == 'Q2') & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值增速')]['指标值'].values[0]

# 2023年哈尔滨的所有经济指标有哪些？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨')]['经济指标名称'].unique()

# 2023年第二季度哈尔滨的经济数据是什么？
df[(df['年份'] == 2023) & (df['年季度'] == 'Q2') & (df['地区名称'] == '哈尔滨')]

# 2023年哈尔滨的地区生产总值总和是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值')]['指标值'].sum()

# 2023年哈尔滨的地区生产总值平均增速是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值增速')]['指标值'].mean()

# 2023年哈尔滨各季度的地区生产总值增速是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值增速')].groupby('年季度')['指标值'].first()

# 2023年哈尔滨各季度的地区生产总值分别是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值')].groupby('年季度')['指标值'].first()

# 哈尔滨地区生产总值在2023年第一季度和第二季度的变化是多少？
gdp_q1q2 = df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值') & (df['年季度'].isin(['Q1', 'Q2']))].set_index('年季度')['指标值']
gdp_q1q2['Q2'] - gdp_q1q2['Q1']

# 2023年第一季度哈尔滨的地区生产总值和增速之间有什么关系？
df[(df['年份'] == 2023) & (df['年季度'] == 'Q1') & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'].isin(['地区生产总值', '地区生产总值增速']))].set_index('经济指标名称')['指标值']

# 2023年第二季度哈尔滨的地区生产总值和增速分别是多少？
df[(df['年份'] == 2023) & (df['年季度'] == 'Q2') & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'].isin(['地区生产总值', '地区生产总值增速']))].set_index('经济指标名称')['指标值']

现在用户提问是：2023年第一季度哈尔滨地区生产总值占全国地区生产总值多少?
                """
            }
        ]
    })
    headers = {
        'Content-Type': 'application/json'
    }

    response = requests.request("POST", url, headers=headers, data=payload)

    print(response.text)


def main_stream():
    url = "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/ernie-4.0-turbo-8k?access_token=" + get_access_token()

    payload = json.dumps({
        "messages": [
            {
                "role": "user",
                "content": """
你现在是一位pandas专家，精通数据分析和处理。你面对的是一个包含以下schema的数据表:

【id, 地区名称, 年份, 季度, 月份, 经济指标名称, 指标值, 指标单位, 数据来源】

其中df.head(4)为
id 地区名称    年份     季度      月份    经济指标名称     指标值 指标单位  数据来源
1  哈尔滨  2023  Q1  03  地区生产总值增速     5.4    %  省统计局
2  哈尔滨  2023  Q1  03    地区生产总值  1131.2   亿元  省统计局
27  哈尔滨  2023  Q2  06  地区生产总值增速     5.4    %  省统计局
28  哈尔滨  2023  Q2  06    地区生产总值  2451.6   亿元  省统计局

无论用户提出何种类型的数据分析需求，你都能提供准确、高效的pandas代码解决方案。你的专业领域包括但不限于:

1. 基本查询:
   - 筛选特定条件的数据
   - 排序和显示数据
   - 处理缺失值

2. 聚合分析:
   - 使用groupby进行分组统计
   - 计算各种聚合指标(如均值、总和、最大值、最小值等)
   - 透视表操作

3. 指标比较:
   - 计算同比、环比增长率
   - 进行多指标对比分析
   - 绘制对比图表的数据准备

4. 时间序列分析:
   - 重采样和频率转换
   - 移动平均线计算
   - 季节性分解

5. 高级操作:
   - 多表连接和合并
   - 数据重塑(melt, pivot等)
   - 自定义函数应用

对于每个查询，你将:
1. 理解用户的需求
2. 只需要提供清晰、简洁且高效的pandas代码
3. 注意：不需要解对结果进行解释
4. 你的回答应当准确、专业，并且易于理解和实施。
5. 如果用户的问题不明确，你会主动询问以澄清需求。

我现在提供一下样例数据：
# 2023年第二季度哈尔滨的经济数据是什么？
df[(df['地区名称'] == '哈尔滨') & (df['年季度'] == 'Q2')]

# 2023年第二季度哈尔滨的地区生产总值增速是多少
df[(df['年份'] == 2023) & (df['年季度'] == 'Q2') & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值增速')]['指标值'].values[0]

# 2023年哈尔滨的所有经济指标有哪些？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨')]['经济指标名称'].unique()

# 2023年第二季度哈尔滨的经济数据是什么？
df[(df['年份'] == 2023) & (df['年季度'] == 'Q2') & (df['地区名称'] == '哈尔滨')]

# 2023年哈尔滨的地区生产总值总和是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值')]['指标值'].sum()

# 2023年哈尔滨的地区生产总值平均增速是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值增速')]['指标值'].mean()

# 2023年哈尔滨各季度的地区生产总值增速是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值增速')].groupby('年季度')['指标值'].first()

# 2023年哈尔滨各季度的地区生产总值分别是多少？
df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值')].groupby('年季度')['指标值'].first()

# 哈尔滨地区生产总值在2023年第一季度和第二季度的变化是多少？
gdp_q1q2 = df[(df['年份'] == 2023) & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'] == '地区生产总值') & (df['年季度'].isin(['Q1', 'Q2']))].set_index('年季度')['指标值']
gdp_q1q2['Q2'] - gdp_q1q2['Q1']

# 2023年第一季度哈尔滨的地区生产总值和增速之间有什么关系？
df[(df['年份'] == 2023) & (df['年季度'] == 'Q1') & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'].isin(['地区生产总值', '地区生产总值增速']))].set_index('经济指标名称')['指标值']

# 2023年第二季度哈尔滨的地区生产总值和增速分别是多少？
df[(df['年份'] == 2023) & (df['年季度'] == 'Q2') & (df['地区名称'] == '哈尔滨') & (df['经济指标名称'].isin(['地区生产总值', '地区生产总值增速']))].set_index('经济指标名称')['指标值']

现在用户提问是：2023年第一季度哈尔滨地区生产总值占全国地区生产总值多少?
                """
            }
        ],
        "stream": True
    })
    headers = {
        'Content-Type': 'application/json'
    }

    response = requests.request("POST", url, headers=headers, data=payload,
                                stream=True)

    for line in response.iter_lines():
        print(line.decode("UTF-8"))


if __name__ == '__main__':
    # main_stream()
    main()
